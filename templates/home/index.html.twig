{% extends 'base.html.twig' %}

{% block title %}Home
{% endblock %}

{% block body %}
	<div class="container fade-in">
		<div class="text-center mb-5">
			<h1 class="display-4 fw-bold">Welcome to Symfony App</h1>
			<p class="lead text-muted">A modern blog platform built with Symfony</p>
		</div>

		{% if is_granted('ROLE_USER') %}
			<div class="d-grid gap-2 col-md-4 col-sm-6 mx-auto mb-5">
				<a href="{{ path('post_new') }}" class="btn btn-primary btn-lg rounded-pill">Create New Post</a>
			</div>
		{% endif %}

		<h2 class="mb-4">All Posts</h2>

		{% if posts|length > 0 %}
			<div class="row">
				{% for post in posts %}
					<div class="col-md-6 col-lg-4 mb-4">
						<div class="card h-100 shadow-sm">
							<div class="card-body">
								<h5 class="card-title">{{ post.title }}</h5>
								<p class="card-text text-muted">
									{{ post.content|length > 100 ? post.content|slice(0, 100) ~ '...' : post.content }}
								</p>
								<div class="text-muted small mb-2">
									<span>Category:
										<strong>{{ post.category.name }}</strong>
									</span>
									|
									<span>Author:
										<strong>{{ post.author.username }}</strong>
									</span>
									|
									<span>
										{{ post.createdAt|date('d.m.Y H:i') }}
										{% if post.updatedAt and post.updatedAt > post.createdAt %}
											(edited at
											{{ post.updatedAt|date('d.m.Y H:i') }})
										{% endif %}
									</span>
								</div>
								<div class="mt-3">
									<h6>Comments:</h6>
									{% for comment in post.comments %}
										<div class="card mb-2">
											<div class="card-body p-2">
												<div class="d-flex justify-content-between">
													<span class="fw-bold">{{ comment.author.username }}</span>
													<span class="text-muted small">{{ comment.createdAt|date('d.m.Y H:i') }}</span>
												</div>
												<p class="mb-0">{{ comment.content }}</p>

												{% if is_granted('COMMENT_EDIT', comment) or is_granted('COMMENT_DELETE', comment) %}
													<div class="mt-2">
														{% if is_granted('COMMENT_EDIT', comment) %}
															<a href="{{ path('comment_edit', {'id': comment.id}) }}" class="btn btn-sm btn-outline-primary">Edit</a>
														{% endif %}

														{% if is_granted('COMMENT_DELETE', comment) %}
															<form method="post" action="{{ path('comment_delete', {'id': comment.id}) }}" class="d-inline">
																<input type="hidden" name="_token" value="{{ csrf_token('delete-comment' ~ comment.id) }}">
																<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">
																	Delete
																</button>
															</form>
														{% endif %}
													</div>
												{% endif %}
											</div>
										</div>
									{% else %}
										<p class="text-muted small">No comments yet.</p>
									{% endfor %}
								</div>
								{% if app.user %}
									<div class="mt-3">
										{{ form_start(forms[post.id], {
                                        'action': path('comment_add', {'id': post.id}),
                                        'attr': {'class': 'form-inline'}
                                    }) }}
										<div class="input-group">
											{{ form_widget(forms[post.id].content, {
                                                'attr': {
                                                    'placeholder': 'Write a comment...',
                                                    'class': 'form-control form-control-sm'
                                                }
                                            }) }}
											<button type="submit" class="btn btn-primary btn-sm">
												Add
											</button>
										</div>
										{{ form_end(forms[post.id]) }}
									</div>
								{% endif %}
								{% if app.user and (app.user == post.author or is_granted('ROLE_ADMIN')) %}
									<div class="d-flex gap-2 mt-3">
										<a href="{{ path('post_edit', {'id': post.id}) }}" class="btn btn-sm btn-warning rounded-pill">Edit</a>
										<form action="{{ path('post_delete', {'id': post.id}) }}" method="post" onsubmit="return confirm('Are you sure?')">
											<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
											<button class="btn btn-danger btn-sm rounded-pill">Delete</button>
										</form>
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
		{% else %}
			<p class="text-center text-muted">No posts found.</p>
		{% endif %}
	</div>
{% endblock %}
